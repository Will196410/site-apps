(() => {
  "use strict";

  window.SiteApps = window.SiteApps || {};
  window.SiteApps.registry = window.SiteApps.registry || {};
  window.SiteApps.register =
    window.SiteApps.register ||
    function (name, initFn) {
      window.SiteApps.registry[name] = initFn;
    };

  const STYLE_ID = "siteapps-imageresize-style";

  function ensureStyle() {
    let style = document.getElementById(STYLE_ID);
    if (!style) {
      style = document.createElement("style");
      style.id = STYLE_ID;
      document.head.appendChild(style);
    }

    style.textContent = `
[data-app="imageresize"]{
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  max-width: 900px;
  margin: 20px auto;
  border:2px solid #111;
  border-radius:16px;
  padding:20px;
  background:#fff;
}
[data-app="imageresize"] h3{
  margin:0 0 14px;
}
[data-app="imageresize"] .dropzone{
  border:3px dashed #111;
  border-radius:16px;
  padding:40px;
  text-align:center;
  font-weight:900;
  cursor:pointer;
  background:#fafafa;
}
[data-app="imageresize"] .dropzone.dragover{
  background:#eef6ff;
}
[data-app="imageresize"] .controls{
  margin-top:20px;
  display:grid;
  gap:12px;
}
[data-app="imageresize"] input,
[data-app="imageresize"] select{
  padding:10px;
  border:2px solid #111;
  border-radius:10px;
  font-weight:700;
}
[data-app="imageresize"] button{
  padding:10px 14px;
  border:2px solid #111;
  border-radius:10px;
  font-weight:900;
  cursor:pointer;
  background:#fff;
}
[data-app="imageresize"] button.primary{
  background:#111;
  color:#fff;
}
[data-app="imageresize"] .preview{
  margin-top:20px;
  text-align:center;
}
[data-app="imageresize"] canvas{
  max-width:100%;
  border:2px solid #111;
  border-radius:10px;
}
`;
  }

  window.SiteApps.register("imageresize", (container) => {
    ensureStyle();
    container.setAttribute("data-app", "imageresize");

    container.innerHTML = `
<h3>Image Resizer & Exporter</h3>

<div class="dropzone">Drag image here or click to upload</div>
<input type="file" accept="image/*" style="display:none">

<div class="controls">
  <label>Resize Mode:
    <select class="mode">
      <option value="percent">Percentage</option>
      <option value="width">Width</option>
      <option value="height">Height</option>
      <option value="exact">Exact</option>
    </select>
  </label>

  <label>Value:
    <input type="number" class="value" value="50">
  </label>

  <label>
    <input type="checkbox" class="lock" checked>
    Keep aspect ratio
  </label>

  <label>Export format:
    <select class="format">
      <option value="image/png">PNG</option>
      <option value="image/jpeg">JPG</option>
      <option value="image/webp">WebP</option>
      <option value="pdf">PDF</option>
    </select>
  </label>

  <label>JPG/WebP Quality (0.1â€“1):
    <input type="number" class="quality" min="0.1" max="1" step="0.1" value="0.9">
  </label>

  <button class="primary resizeBtn">Resize</button>
  <button class="downloadBtn">Download</button>
</div>

<div class="preview">
  <canvas></canvas>
</div>
`;

    const dropzone = container.querySelector(".dropzone");
    const fileInput = container.querySelector("input[type=file]");
    const canvas = container.querySelector("canvas");
    const ctx = canvas.getContext("2d");

    const modeSel = container.querySelector(".mode");
    const valueInput = container.querySelector(".value");
    const lockInput = container.querySelector(".lock");
    const formatSel = container.querySelector(".format");
    const qualityInput = container.querySelector(".quality");

    const resizeBtn = container.querySelector(".resizeBtn");
    const downloadBtn = container.querySelector(".downloadBtn");

    let originalImg = null;
    let originalWidth = 0;
    let originalHeight = 0;

    function loadFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          originalImg = img;
          originalWidth = img.width;
          originalHeight = img.height;
          drawImage(img.width, img.height);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function drawImage(w, h) {
      canvas.width = w;
      canvas.height = h;
      ctx.clearRect(0, 0, w, h);
      ctx.drawImage(originalImg, 0, 0, w, h);
    }

    dropzone.addEventListener("click", () => fileInput.click());

    dropzone.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropzone.classList.add("dragover");
    });

    dropzone.addEventListener("dragleave", () => {
      dropzone.classList.remove("dragover");
    });

    dropzone.addEventListener("drop", (e) => {
      e.preventDefault();
      dropzone.classList.remove("dragover");
      const file = e.dataTransfer.files[0];
      if (file) loadFile(file);
    });

    fileInput.addEventListener("change", () => {
      if (fileInput.files[0]) loadFile(fileInput.files[0]);
    });

    resizeBtn.addEventListener("click", () => {
      if (!originalImg) return;

      const mode = modeSel.value;
      const val = parseFloat(valueInput.value);
      let newW = originalWidth;
      let newH = originalHeight;

      if (mode === "percent") {
        newW = originalWidth * (val / 100);
        newH = originalHeight * (val / 100);
      } else if (mode === "width") {
        newW = val;
        if (lockInput.checked)
          newH = originalHeight * (val / originalWidth);
      } else if (mode === "height") {
        newH = val;
        if (lockInput.checked)
          newW = originalWidth * (val / originalHeight);
      } else if (mode === "exact") {
        newW = val;
        newH = val;
      }

      drawImage(Math.round(newW), Math.round(newH));
    });

    downloadBtn.addEventListener("click", () => {
      if (!originalImg) return;

      const format = formatSel.value;

      if (format === "pdf") {
        const imgData = canvas.toDataURL("image/jpeg", 1.0);

        const pdfWindow = window.open("");
        pdfWindow.document.write(`
          <html>
          <body style="margin:0">
          <img src="${imgData}" style="width:100%">
          <script>
          window.print();
          </script>
          </body>
          </html>
        `);
      } else {
        const quality = parseFloat(qualityInput.value) || 0.9;
        const link = document.createElement("a");
        link.download = "resized-image";
        link.href = canvas.toDataURL(format, quality);
        link.click();
      }
    });
  });
})();
